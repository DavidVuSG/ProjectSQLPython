<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Search Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <input type="text" id="search-box" placeholder="Type to search...">
    <button onclick="fetchData()">Search</button>
    <button onclick="clearSelection()">Clear Selection</button>

    <div id="summary-box" style="margin-top: 10px; font-weight: bold; color: #004d00;">
        Selected Rows: 0 | Total SOLUONG: 0 | Total SOTHUNG: 0
    </div>

    <div class="table-container">
        <table id="data-table">
            <thead>
                <tr id="table-head"></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
    let selectedRows = new Set();
    let lastSelectedIndex = null;

    document.getElementById("search-box").addEventListener("input", fetchData);
    window.onload = fetchData;

    function fetchData() {
        const query = document.getElementById("search-box").value;
        fetch(`/search?q=${query}`)
            .then(response => response.json())
            .then(data => renderTable(data));
    }

    function renderTable(data) {
        const thead = document.getElementById("table-head");
        const tbody = document.querySelector("#data-table tbody");
        thead.innerHTML = "";
        tbody.innerHTML = "";
        selectedRows.clear();
        lastSelectedIndex = null;

        data.headers.forEach(header => {
            const th = document.createElement("th");
            th.textContent = header;
            thead.appendChild(th);
        });

        data.rows.forEach((item, index) => {
            const tr = document.createElement("tr");
            if (item.class) tr.classList.add(item.class);

            item.row.forEach(cell => {
                const td = document.createElement("td");
                td.textContent = cell;
                tr.appendChild(td);
            });

            tr.addEventListener("click", (event) => {
                const tableRows = document.querySelectorAll("#data-table tbody tr");

                if (event.shiftKey && lastSelectedIndex !== null) {
                    const [start, end] = [lastSelectedIndex, index].sort((a, b) => a - b);
                    for (let i = start; i <= end; i++) {
                        selectedRows.add(i);
                        tableRows[i].style.backgroundColor = "#cce5ff";
                    }
                } else {
                    if (selectedRows.has(index)) {
                        selectedRows.delete(index);
                        tr.style.backgroundColor = "";
                    } else {
                        selectedRows.add(index);
                        tr.style.backgroundColor = "#cce5ff";
                    }
                    lastSelectedIndex = index;
                }

                updateSummary(data.rows);
            });

            tbody.appendChild(tr);
        });

        updateSummary(data.rows);
    }

    function updateSummary(rows) {
        let count = 0;
        let sumSoluong = 0;
        let sumSothung = 0;

        selectedRows.forEach(i => {
            const row = rows[i].row;
            count += 1;
            sumSoluong += parseInt(row[4]) || 0;
            sumSothung += parseInt(row[5]) || 0;
        });

        document.getElementById("summary-box").innerText =
            `Selected Rows: ${count} | Total SOLUONG: ${sumSoluong} | Total SOTHUNG: ${sumSothung}`;
    }

    function clearSelection() {
        selectedRows.clear();
        lastSelectedIndex = null;

        const tableRows = document.querySelectorAll("#data-table tbody tr");
        tableRows.forEach(row => {
            row.style.backgroundColor = "";
        });

        updateSummary([]);
    }
    </script>
</body>
</html>
